<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ghép Ảnh Vào Khung</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    canvas { border: 1px solid #ccc; margin-top: 10px; cursor: move; }
    .controls { margin: 10px; }
    button { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h2>Ghép Ảnh Vào Khung</h2>
  
  <div class="controls">
    <input type="file" id="upload" accept="image/*">
    <button id="apply">Gắn vào khung</button>
    <button id="zoomIn">+</button>
    <button id="zoomOut">-</button>
    <button id="download">Download</button>
  </div>

  <canvas id="canvas" width="600" height="600"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let frame = new Image();
    frame.src = "frame.png"; // PNG có phần nền đỏ + chỗ trống trong suốt

    let userImg = null;
    let userX = 0, userY = 0;
    let scale = 1;
    let baseWidth = 0, baseHeight = 0;

    let isDragging = false;
    let offsetX, offsetY;

    function redraw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (userImg) {
        const drawW = baseWidth * scale;
        const drawH = baseHeight * scale;
        ctx.drawImage(userImg, userX, userY, drawW, drawH);
      }
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
    }

    // Upload file
    let uploadedFile = null;
    document.getElementById("upload").addEventListener("change", (e) => {
      uploadedFile = e.target.files[0];
    });

    // Gắn ảnh
    document.getElementById("apply").addEventListener("click", () => {
      if (!uploadedFile) return alert("Hãy chọn ảnh trước!");
      const reader = new FileReader();
      reader.onload = (ev) => {
        userImg = new Image();
        userImg.onload = () => {
          const ratio = Math.min(canvas.width / userImg.width, canvas.height / userImg.height);
          baseWidth = userImg.width * ratio;
          baseHeight = userImg.height * ratio;
          scale = 1;
          userX = (canvas.width - baseWidth) / 2;
          userY = (canvas.height - baseHeight) / 2;
          redraw();
        };
        userImg.src = ev.target.result;
      };
      reader.readAsDataURL(uploadedFile);
    });

    // Kéo thả ảnh
    canvas.addEventListener("mousedown", (e) => {
      if (!userImg) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const drawW = baseWidth * scale;
      const drawH = baseHeight * scale;
      if (x > userX && x < userX + drawW && y > userY && y < userY + drawH) {
        isDragging = true;
        offsetX = x - userX;
        offsetY = y - userY;
      }
    });

    canvas.addEventListener("mousemove", (e) => {
      if (isDragging) {
        const rect = canvas.getBoundingClientRect();
        userX = e.clientX - rect.left - offsetX;
        userY = e.clientY - rect.top - offsetY;
        redraw();
      }
    });

    canvas.addEventListener("mouseup", () => { isDragging = false; });
    canvas.addEventListener("mouseleave", () => { isDragging = false; });

    // Zoom bằng nút
    document.getElementById("zoomIn").addEventListener("click", () => {
      if (!userImg) return;
      scale *= 1.1;
      redraw();
    });

    document.getElementById("zoomOut").addEventListener("click", () => {
      if (!userImg) return;
      scale /= 1.1;
      redraw();
    });

    // Zoom bằng con lăn chuột
    canvas.addEventListener("wheel", (e) => {
      if (!userImg) return;
      e.preventDefault();
      if (e.deltaY < 0) {
        scale *= 1.1; // zoom in
      } else {
        scale /= 1.1; // zoom out
      }
      redraw();
    });

    // Download
    document.getElementById("download").addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "anh-ghep.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    frame.onload = redraw;
  </script>
</body>
</html>
